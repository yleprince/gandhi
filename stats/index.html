<!DOCTYPE html>
<html lang="en" data-theme="winter">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Gandhi Stats</title>
        <link rel="icon" href="/static/india.png">
        <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.min.css" rel="stylesheet" type="text/css">
        <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    </head>
    <body class="min-h-screen bg-gradient-to-r from-pink-500 to-orange-500">


        <div id="layout" class="pb-8">
            <h1 class="text-6xl sm:text-8xl text-white font-extrabold py-6 px-4">Gandhi Orders Stats</h1>
            <div class="sm:flex sm:flex-row mt-12">
                <div class="grow flex justify-center">
                    <div class="stats stats-vertical sm:stats-horizontal shadow">
                        <div class="stat">
                            <div class="stat-figure text-pink-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                            </div>
                            <div class="stat-title">Total Spend</div>
                            <div class="stat-value bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-orange-500" id="total-price">
                                <img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader">
                            </div>
                        </div>

                        <div class="stat">
                            <div class="stat-figure text-pink-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" />
                                </svg>

                            </div>
                            <div class="stat-title">Total Dishes Ordered</div>
                            <div class="stat-value bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-orange-500" id="nb-dish">
                                <img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader">
                            </div>
                        </div>

                        <div class="stat">
                            <div class="stat-figure text-pink-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                                </svg>
                            </div>
                            <div class="stat-title">Number of Users</div>
                            <div class="stat-value bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-orange-500" id="nb-user">
                                <img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="layout" class="pb-8">
            <div class="sm:flex sm:flex-row">
                <div class="grow flex justify-center">
                    <div>
                        <h2 class="text-xl p-2 text-white font-medium">User Stats</h2>
                        <table id="user_stats_table" class="sm:m-6 table table-xs bg-white rounded-xl shadow-xl">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)">User<img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader"></th>
                                    <th onclick="sortTable(1)">Nb Dishes Ordered<img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader"></th>
                                    <th onclick="sortTable(2)">Total Price<img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader"></th>
                                    <th onclick="sortTable(3)">Favorite Dish<img src="/static/india.png" alt="Loading..." class="w-8 h-8 animate-spin loader"></th>
                                </tr>
                            </thead>
                            <tbody id="user_stats"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </body>
    <script>
        const url = "https://script.google.com/macros/s/AKfycbxuRINtkSRYAC7Kle9g5urtW5GBWbjrvS4YCQo-LT9yWqD_Ed9MZ_FAaJcx4EgdvK0xlg/exec"
        const apiUrl = `${url}?action=getAll`;

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        function fromUidToStr(uid) {
            return capitalizeFirstLetter(uid.replace("_", " ").replace("-", " "))
        }

        function computePrice(price, quantity) {
            const price_ = parseFloat(price.substring(0, price.length - 1))
            return price_ * quantity;
        }

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                fetch("/static/menu.json").then(response => response.json()).then(menu => menu.map(d => Array.from([d.id, d.Price])))
                    .then(menu => {
                        const priceMap = new Map(menu);
                        const ordered = data.data.sort((a, b) => a.owner.localeCompare(b.owner));

                        const grouped = Object.entries(ordered.reduce((acc, curr) => {
                            if (acc[curr.item]) {
                                acc[curr.item] += curr.quantity;
                            } else {
                                acc[curr.item] = curr.quantity;
                            }
                            return acc;
                        }, {})).sort((a,b) => b[1] - a[1])

                        const loaders = Array.from(document.getElementsByClassName('loader'));
                        loaders.map(loader => loader.remove());

                        const totalPrice = grouped.reduce((acc, curr) => {
                            const price = priceMap.get(curr[0]);
                            return acc + computePrice(price, curr[1]);
                        }, 0);
                        document.getElementById('total-price').innerHTML = totalPrice ;

                        const nbDish = grouped.reduce((acc, curr) => acc + curr[1], 0);
                        document.getElementById('nb-dish').innerHTML = nbDish;

                        const users = new Set(ordered.map(o => o.owner));
                        const nbUser = users.size;
                        document.getElementById('nb-user').innerHTML = nbUser;

                        const userStatsTable = document.getElementById('user_stats');
                        userStatsTable.innerHTML = "";
                        const aggregated = ordered.reduce((acc, { owner, item, quantity }) => {
                            const key = `${owner}-${item}`;
                            if (!acc[key]) {
                                acc[key] = { owner, item, quantity: 0 };
                            }
                            acc[key].quantity += quantity;
                            return acc;
                        }, {});

                        // Convert the result to an array
                        const result = Object.values(aggregated);

                        users.forEach(user => {
                            const userStats = result.filter(r => r.owner === user);
                            const favoriteDish = userStats.reduce((acc, curr) => {
                                if (acc.quantity < curr.quantity) {
                                    acc = curr;
                                }
                                return acc;
                            }, { quantity: 0 });

                            const totalPrice = userStats.reduce((acc, curr) => {
                                const price = priceMap.get(curr.item);
                                return acc + computePrice(price, curr.quantity);
                            }, 0);

                            const totalDishes = userStats.reduce((acc, curr) => acc + curr.quantity, 0);

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${fromUidToStr(user)}</td>
                                <td>${totalDishes}</td>
                                <td>${totalPrice}</td>
                                <td>${fromUidToStr(favoriteDish.item)}</td>
                                `;
                            userStatsTable.appendChild(row);
                        });
                    })
            });

        let sortDirections = {};

        function sortTable(colIndex) {
            const table = document.getElementById('user_stats_table');
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);

            // Toggle sort direction: default asc
            sortDirections[colIndex] = !sortDirections[colIndex];

            rows.sort((a, b) => {
                let valA = a.cells[colIndex].textContent.trim();
                let valB = b.cells[colIndex].textContent.trim();

                // Try to convert to number or date
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return sortDirections[colIndex] ? numA - numB : numB - numA;
                }

                const dateA = Date.parse(valA);
                const dateB = Date.parse(valB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return sortDirections[colIndex] ? dateA - dateB : dateB - dateA;
                }

                return sortDirections[colIndex]
                    ? valA.localeCompare(valB)
                    : valB.localeCompare(valA);
            });

            // Reattach sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

    </script>
</html>
